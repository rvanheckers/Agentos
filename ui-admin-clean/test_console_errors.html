<!DOCTYPE html>
<html>
<head>
    <title>Console Error Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .console { background: #000; color: #0f0; font-family: monospace; padding: 15px; height: 400px; overflow-y: auto; }
        .error { color: #f00; }
        .warn { color: #fa0; }
        .info { color: #0af; }
        .log { color: #0f0; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Analytics Console Error Test</h1>
    
    <button onclick="loadAnalyticsAndWait()">Load Analytics & Wait for Errors</button>
    <button onclick="clearConsole()">Clear Console</button>
    
    <div id="status"></div>
    <div id="console" class="console"></div>
    
    <iframe id="testFrame" style="width: 100%; height: 400px; display: none; border: 1px solid #ccc;"></iframe>
    
    <script>
        const consoleDiv = document.getElementById('console');
        const statusDiv = document.getElementById('status');
        let consoleMessages = [];
        
        // Capture all console output
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };
        
        function logToDiv(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleMessages.push({type, message, timestamp});
            
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            consoleDiv.appendChild(div);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            logToDiv('log', args.join(' '));
            originalConsole.log.apply(console, args);
        };
        
        console.error = function(...args) {
            logToDiv('error', args.join(' '));
            originalConsole.error.apply(console, args);
        };
        
        console.warn = function(...args) {
            logToDiv('warn', args.join(' '));
            originalConsole.warn.apply(console, args);
        };
        
        console.info = function(...args) {
            logToDiv('info', args.join(' '));
            originalConsole.info.apply(console, args);
        };
        
        function clearConsole() {
            consoleDiv.innerHTML = '';
            consoleMessages = [];
            statusDiv.innerHTML = '';
        }
        
        function updateStatus(message, type = 'info') {
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        async function loadAnalyticsAndWait() {
            clearConsole();
            updateStatus('Loading Analytics view and monitoring console...', 'info');
            
            const iframe = document.getElementById('testFrame');
            iframe.style.display = 'block';
            
            let loadTimeout;
            const errorCount = {errors: 0, warnings: 0};
            
            // Start counting errors
            const startTime = Date.now();
            
            // Consolidated iframe load handler - combines both behaviors
            function handleIframeLoad() {
                logToDiv('log', '‚úÖ Analytics page loaded in iframe');
                
                try {
                    const iframeWindow = iframe.contentWindow;
                    
                    // Override iframe console to capture messages
                    const iframeConsole = iframeWindow.console;
                    
                    iframeWindow.console.error = function(...args) {
                        const message = args.join(' ');
                        logToDiv('error', `[IFRAME] ${message}`);
                        consoleMessages.push({ type: 'error', message: message, timestamp: Date.now() });
                        errorCount.errors++;
                        iframeConsole.error.apply(iframeConsole, args);
                    };
                    
                    iframeWindow.console.warn = function(...args) {
                        const message = args.join(' ');
                        logToDiv('warn', `[IFRAME] ${message}`);
                        consoleMessages.push({ type: 'warn', message: message, timestamp: Date.now() });
                        errorCount.warnings++;
                        iframeConsole.warn.apply(iframeConsole, args);
                    };
                    
                    iframeWindow.console.log = function(...args) {
                        const message = args.join(' ');
                        logToDiv('log', `[IFRAME] ${message}`);
                        consoleMessages.push({ type: 'log', message: message, timestamp: Date.now() });
                        iframeConsole.log.apply(iframeConsole, args);
                    };
                    
                    logToDiv('log', 'üîç Iframe console hooks installed, monitoring for errors...');
                    
                } catch (e) {
                    logToDiv('warn', `Could not hook iframe console: ${e.message}`);
                }
                
                // Clear any existing timeout to prevent double execution
                if (loadTimeout) {
                    clearTimeout(loadTimeout);
                }
                
                // Set analysis timeout - wait for JavaScript to execute and catch delayed errors
                loadTimeout = setTimeout(() => {
                    const errors = consoleMessages.filter(m => m.type === 'error');
                    const warnings = consoleMessages.filter(m => m.type === 'warn');
                    const logs = consoleMessages.filter(m => m.type === 'log');
                    
                    logToDiv('log', `üîç Analysis complete after ${Math.round((Date.now() - startTime)/1000)}s:`);
                    logToDiv('info', `üìä ${logs.length} log messages`);
                    logToDiv('warn', `‚ö†Ô∏è ${warnings.length} warning messages`);
                    logToDiv('error', `‚ùå ${errors.length} error messages`);
                    
                    // Final status determination
                    if (errors.length === 0) {
                        updateStatus('‚úÖ SUCCESS: No console errors detected!', 'success');
                        logToDiv('log', 'üéâ Analytics view loads cleanly without errors');
                    } else {
                        updateStatus(`‚ùå FAIL: ${errors.length} console errors found`, 'fail');
                        logToDiv('error', `üö® Issues detected that need fixing:`);
                        errors.slice(0, 5).forEach(error => {
                            logToDiv('error', `   ‚Üí ${error.message}`);
                        });
                        if (errors.length > 5) {
                            logToDiv('error', `   ... and ${errors.length - 5} more errors`);
                        }
                    }
                    
                    if (warnings.length > 0) {
                        logToDiv('warn', '‚ö†Ô∏è Warnings found (may need attention):');
                        warnings.slice(0, 3).forEach(warn => {
                            logToDiv('warn', `   ‚Üí ${warn.message}`);
                        });
                        if (warnings.length > 3) {
                            logToDiv('warn', `   ... and ${warnings.length - 3} more warnings`);
                        }
                    }
                    
                    logToDiv('log', `üìã Final Results: ${errors.length} errors, ${warnings.length} warnings`);
                    
                }, 5000); // Wait 5 seconds for all JavaScript to execute
            }
            
            // Use addEventListener to avoid overwriting
            iframe.addEventListener('load', handleIframeLoad);
            
            iframe.onerror = function(error) {
                logToDiv('error', `‚ùå Iframe load error: ${error}`);
                updateStatus('‚ùå Failed to load Analytics view', 'fail');
                if (loadTimeout) {
                    clearTimeout(loadTimeout);
                    loadTimeout = null;
                }
            };
            
            // Load the analytics page
            iframe.src = 'index.html#analytics';
        }
        
        logToDiv('log', 'üîç Console monitor ready. Click "Load Analytics" to test.');
    </script>
</body>
</html>