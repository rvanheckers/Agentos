<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 Queue UI Functions Test</title>
    <style>
        body { font-family: system-ui; margin: 20px; background: #f5f5f5; }
        .test-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-item { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .test-result { font-weight: bold; margin-left: 10px; }
        .test-result.pass { color: green; }
        .test-result.fail { color: red; }
        .test-result.pending { color: orange; }
        button { margin: 5px; padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .log { background: #000; color: #00ff00; padding: 10px; font-family: monospace; font-size: 12px; height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 Queue UI Functions Test</h1>
        <p>Test alle knoppen en filters in de Jobs & Queue view</p>
        
        <div class="test-item">
            <h3>📊 Search & Filter Functions</h3>
            <button onclick="testSearchFilter()">Test Search Function</button>
            <span id="search-result" class="test-result pending">PENDING</span>
        </div>
        
        <div class="test-item">
            <h3>🎯 Status Filter</h3>
            <button onclick="testStatusFilter()">Test Status Filter</button>
            <span id="status-result" class="test-result pending">PENDING</span>
        </div>
        
        <div class="test-item">
            <h3>📅 Date Range Filter</h3>
            <button onclick="testDateFilter()">Test Date Range Filter</button>
            <span id="date-result" class="test-result pending">PENDING</span>
        </div>
        
        <div class="test-item">
            <h3>📤 Export Functions</h3>
            <button onclick="testExportFunction()">Test Export CSV</button>
            <span id="export-result" class="test-result pending">PENDING</span>
        </div>
        
        <div class="test-item">
            <h3>🔄 Bulk Operations</h3>
            <button onclick="testBulkOperations()">Test Bulk Selection</button>
            <span id="bulk-result" class="test-result pending">PENDING</span>
        </div>
        
        <div class="test-item">
            <h3>📄 Pagination</h3>
            <button onclick="testPagination()">Test Pagination</button>
            <span id="pagination-result" class="test-result pending">PENDING</span>
        </div>
        
        <div class="test-item">
            <h3>📝 Test Log</h3>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function setTestResult(id, status, message = '') {
            const element = document.getElementById(id);
            element.className = `test-result ${status}`;
            element.textContent = status.toUpperCase() + (message ? ` - ${message}` : '');
        }
        
        async function testSearchFilter() {
            log('🔍 Testing search filter function...');
            setTestResult('search-result', 'pending');
            
            try {
                // Test if we can access the admin UI and find search elements
                const response = await fetch('http://localhost:8004/', { mode: 'no-cors' });
                log('✅ Admin UI accessible for search test');
                
                // Simulate search filter logic
                const mockJobs = [
                    { id: 'test-job-1', user_id: 'user1', video_url: 'test.mp4' },
                    { id: 'another-job', user_id: 'user2', video_url: 'video.mp4' }
                ];
                
                // Test search logic
                const searchTerm = 'test';
                const filtered = mockJobs.filter(job => 
                    job.id.toLowerCase().includes(searchTerm) ||
                    (job.user_id && job.user_id.toLowerCase().includes(searchTerm)) ||
                    (job.video_url && job.video_url.toLowerCase().includes(searchTerm))
                );
                
                if (filtered.length === 1 && filtered[0].id === 'test-job-1') {
                    setTestResult('search-result', 'pass', 'Search logic working');
                    log('✅ Search filter: Logic validated');
                } else {
                    setTestResult('search-result', 'fail', 'Search logic failed');
                    log('❌ Search filter: Logic failed');
                }
                
            } catch (error) {
                setTestResult('search-result', 'fail', error.message);
                log(`❌ Search test: ${error.message}`);
            }
        }
        
        async function testStatusFilter() {
            log('🎯 Testing status filter function...');
            setTestResult('status-result', 'pending');
            
            try {
                const mockJobs = [
                    { id: 'job-1', status: 'completed' },
                    { id: 'job-2', status: 'processing' },
                    { id: 'job-3', status: 'failed' },
                    { id: 'job-4', status: 'queued' }
                ];
                
                // Test status filter for live queue (processing, queued, pending)
                const liveQueueJobs = mockJobs.filter(job => 
                    ['queued', 'processing', 'pending'].includes(job.status)
                );
                
                // Test status filter for job history (completed, failed, cancelled)
                const historyJobs = mockJobs.filter(job =>
                    ['completed', 'failed', 'cancelled'].includes(job.status)
                );
                
                if (liveQueueJobs.length === 2 && historyJobs.length === 2) {
                    setTestResult('status-result', 'pass', 'Status filters working');
                    log(`✅ Status filter: Live queue ${liveQueueJobs.length}, History ${historyJobs.length}`);
                } else {
                    setTestResult('status-result', 'fail', 'Status filter logic failed');
                }
                
            } catch (error) {
                setTestResult('status-result', 'fail', error.message);
                log(`❌ Status test: ${error.message}`);
            }
        }
        
        async function testDateFilter() {
            log('📅 Testing date range filter function...');
            setTestResult('date-result', 'pending');
            
            try {
                const now = new Date();
                const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                const lastWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                
                const mockJobs = [
                    { id: 'job-today', created_at: now.toISOString() },
                    { id: 'job-yesterday', created_at: yesterday.toISOString() },
                    { id: 'job-lastweek', created_at: lastWeek.toISOString() }
                ];
                
                // Test "today" filter
                const todayJobs = mockJobs.filter(job => {
                    const jobDate = new Date(job.created_at);
                    return jobDate.toDateString() === now.toDateString();
                });
                
                // Test "week" filter
                const weekCutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                const weekJobs = mockJobs.filter(job => {
                    return new Date(job.created_at) >= weekCutoff;
                });
                
                if (todayJobs.length === 1 && weekJobs.length === 2) {
                    setTestResult('date-result', 'pass', 'Date filters working');
                    log(`✅ Date filter: Today ${todayJobs.length}, Week ${weekJobs.length}`);
                } else {
                    setTestResult('date-result', 'fail', 'Date filter logic failed');
                }
                
            } catch (error) {
                setTestResult('date-result', 'fail', error.message);
                log(`❌ Date test: ${error.message}`);
            }
        }
        
        async function testExportFunction() {
            log('📤 Testing export CSV function...');
            setTestResult('export-result', 'pending');
            
            try {
                const mockJobs = [
                    { 
                        id: 'job-1', 
                        status: 'completed', 
                        created_at: '2025-08-03T10:00:00Z',
                        progress: 100,
                        user_id: 'user1',
                        video_url: 'test.mp4',
                        current_step: 'Completed',
                        error_message: null,
                        started_at: '2025-08-03T10:00:05Z',
                        completed_at: '2025-08-03T10:00:30Z'
                    }
                ];
                
                // Test CSV generation logic
                const headers = ['ID', 'Status', 'Created At', 'Progress', 'User ID', 'Video URL', 'Current Step', 'Error Message', 'Duration'];
                const csvContent = [
                    headers.join(','),
                    ...mockJobs.map(job => [
                        job.id,
                        job.status,
                        job.created_at,
                        job.progress + '%',
                        job.user_id || '',
                        job.video_url || '',
                        job.current_step || '',
                        job.error_message || '',
                        '25s' // Duration calculation
                    ].join(','))
                ].join('\\n');
                
                if (csvContent.includes('job-1,completed') && csvContent.includes('ID,Status')) {
                    // Test Blob creation (browser API)
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    
                    if (blob.size > 0) {
                        setTestResult('export-result', 'pass', 'CSV export working');
                        log('✅ Export function: CSV generation successful');
                    } else {
                        setTestResult('export-result', 'fail', 'Blob creation failed');
                    }
                } else {
                    setTestResult('export-result', 'fail', 'CSV format incorrect');
                }
                
            } catch (error) {
                setTestResult('export-result', 'fail', error.message);
                log(`❌ Export test: ${error.message}`);
            }
        }
        
        async function testBulkOperations() {
            log('🔄 Testing bulk operations function...');
            setTestResult('bulk-result', 'pending');
            
            try {
                // Simulate bulk selection logic
                const selectedJobs = new Set();
                const mockJobIds = ['job-1', 'job-2', 'job-3'];
                
                // Test add to selection
                mockJobIds.forEach(id => selectedJobs.add(id));
                
                // Test bulk operations availability
                const hasBulkActions = selectedJobs.size > 0;
                const canRetry = true; // Mock permission check
                const canCancel = true; // Mock permission check
                const canExport = true; // Mock permission check
                
                if (selectedJobs.size === 3 && hasBulkActions && canRetry && canCancel && canExport) {
                    setTestResult('bulk-result', 'pass', 'Bulk operations ready');
                    log(`✅ Bulk operations: ${selectedJobs.size} jobs selected, all actions available`);
                } else {
                    setTestResult('bulk-result', 'fail', 'Bulk logic failed');
                }
                
            } catch (error) {
                setTestResult('bulk-result', 'fail', error.message);
                log(`❌ Bulk test: ${error.message}`);
            }
        }
        
        async function testPagination() {
            log('📄 Testing pagination function...');
            setTestResult('pagination-result', 'pending');
            
            try {
                const mockJobs = Array.from({length: 55}, (_, i) => ({ id: `job-${i+1}`, status: 'completed' }));
                const itemsPerPage = 10;
                
                // Test pagination logic
                const totalPages = Math.ceil(mockJobs.length / itemsPerPage);
                const currentPage = 1;
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const currentPageJobs = mockJobs.slice(startIndex, endIndex);
                
                if (totalPages === 6 && currentPageJobs.length === 10 && currentPageJobs[0].id === 'job-1') {
                    setTestResult('pagination-result', 'pass', `${totalPages} pages, ${itemsPerPage} per page`);
                    log(`✅ Pagination: ${totalPages} pages, ${currentPageJobs.length} items on page 1`);
                } else {
                    setTestResult('pagination-result', 'fail', 'Pagination logic failed');
                }
                
            } catch (error) {
                setTestResult('pagination-result', 'fail', error.message);
                log(`❌ Pagination test: ${error.message}`);
            }
        }
        
        // Auto-run basic tests
        window.addEventListener('load', () => {
            log('🚀 Queue UI Functions Test Suite loaded');
            setTimeout(() => {
                testSearchFilter();
                setTimeout(() => testStatusFilter(), 500);
                setTimeout(() => testDateFilter(), 1000);
                setTimeout(() => testExportFunction(), 1500);
                setTimeout(() => testBulkOperations(), 2000);
                setTimeout(() => testPagination(), 2500);
            }, 500);
        });
    </script>
</body>
</html>